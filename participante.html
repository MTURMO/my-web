<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Participante - Login / Registro</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  font-family: 'Inter', sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  background: #f0f4f8;
  margin: 0;
}
.container {
  background: white;
  border-radius: 12px;
  padding: 30px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  width: 100%;
  max-width: 400px;
}
h1 {
  text-align: center;
  color: #333;
  margin-bottom: 15px;
}
.tabs {
  display: flex;
  justify-content: space-around;
  margin-bottom: 20px;
}
.tabs button {
  background: none;
  border: none;
  font-weight: 600;
  color: #555;
  cursor: pointer;
  padding: 10px;
  border-bottom: 2px solid transparent;
  transition: color 0.2s, border-color 0.2s;
}
.tabs button.active {
  color: #2563eb;
  border-bottom: 2px solid #2563eb;
}
input, button {
  width: 100%;
  padding: 12px;
  margin: 8px 0;
  border-radius: 10px;
  border: 1px solid #ddd;
  font-size: 15px;
}
button {
  background: linear-gradient(90deg, #4f46e5, #3b82f6);
  color: white;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.2s;
}
button:hover { transform: translateY(-2px); }
#message {
  text-align: center;
  margin-top: 10px;
  font-size: 14px;
}
a {
  display: block;
  margin-top: 15px;
  text-align: center;
  color: #3b82f6;
  text-decoration: none;
}
</style>
</head>
<body>

<div class="container">
  <h1>Participante</h1>

  <div class="tabs">
    <button id="tabLogin" class="active">Iniciar Sessi√≥</button>
    <button id="tabRegister">Registrar-se</button>
  </div>

  <!-- LOGIN -->
  <div id="loginForm">
    <input type="email" id="loginEmail" placeholder="Correu" required>
    <input type="password" id="loginPassword" placeholder="Contrasenya" required>
    <button id="btnLogin">Entrar</button>
  </div>

  <!-- REGISTRO -->
  <div id="registerForm" style="display:none;">
    <input type="text" id="regNombre" placeholder="Nombre completo" required>
    <input type="email" id="regEmail" placeholder="Correo" required>
    <input type="password" id="regPassword" placeholder="Contrase√±a" required>
    <button id="btnRegister">Crear cuenta</button>
  </div>

  <div id="message"></div>
  <a href="index.html">‚¨Ö Volver al men√∫ principal</a>
</div>

<script type="module">
import { supabase } from './supabaseClient.js';

// Tabs
const tabLogin = document.getElementById("tabLogin");
const tabRegister = document.getElementById("tabRegister");
const loginForm = document.getElementById("loginForm");
const registerForm = document.getElementById("registerForm");
const msg = document.getElementById("message");

tabLogin.addEventListener("click", () => {
  tabLogin.classList.add("active");
  tabRegister.classList.remove("active");
  loginForm.style.display = "block";
  registerForm.style.display = "none";
  msg.textContent = "";
});

tabRegister.addEventListener("click", () => {
  tabRegister.classList.add("active");
  tabLogin.classList.remove("active");
  registerForm.style.display = "block";
  loginForm.style.display = "none";
  msg.textContent = "";
});

// üü© REGISTRO DE USUARIO
document.getElementById("btnRegister").addEventListener("click", async () => {
  msg.textContent = "";
  const nombre = document.getElementById("regNombre").value.trim();
  const email = document.getElementById("regEmail").value.trim();
  const password = document.getElementById("regPassword").value.trim();

  if (!nombre || !email || !password) {
    msg.textContent = "‚ö†Ô∏è Completa todos los campos.";
    msg.style.color = "orange";
    return;
  }

  // Crear usuario en Supabase Auth
  const { data: signUpData, error: signUpError } = await supabase.auth.signUp({
    email,
    password,
    options: { data: { nombre } }
  });

  if (signUpError) {
    msg.textContent = "‚ùå Error al registrarse: " + signUpError.message;
    msg.style.color = "red";
    return;
  }

  // Esperar uns segons i recuperar sessi√≥ per obtenir el user.id
  const { data: sessionData } = await supabase.auth.getSession();
  const user = sessionData?.session?.user || signUpData.user;

  if (!user) {
    msg.textContent = "‚ö†Ô∏è Error creando el usuario. Int√©ntalo de nuevo.";
    msg.style.color = "orange";
    return;
  }

  // Guardar en la tabla perfil_participantes
  const { error: insertError } = await supabase.from("perfil_participantes").insert([
    { id: user.id, nombre, correo: email }
  ]);

  if (insertError) {
    msg.textContent = "‚ö†Ô∏è Error al guardar perfil: " + insertError.message;
    msg.style.color = "red";
    return;
  }

  msg.textContent = "‚úÖ Cuenta creada correctamente. Ya puedes iniciar sesi√≥n.";
  msg.style.color = "green";
  tabLogin.click();
});

// üü¶ LOGIN DE USUARIO
document.getElementById("btnLogin").addEventListener("click", async () => {
  msg.textContent = "";
  const email = document.getElementById("loginEmail").value.trim();
  const password = document.getElementById("loginPassword").value.trim();

  if (!email || !password) {
    msg.textContent = "‚ö†Ô∏è Completa todos los campos.";
    msg.style.color = "orange";
    return;
  }

  // üîπ Intentar iniciar sessi√≥
  const { data: loginData, error: loginError } = await supabase.auth.signInWithPassword({
    email,
    password
  });

  if (loginError) {
    msg.textContent = "‚ùå Credencials incorrectes o error al iniciar sessi√≥.";
    msg.style.color = "red";
    console.error(loginError);
    return;
  }

  // üîπ Recuperar sessi√≥ per obtenir user.id
  const { data: sessionData } = await supabase.auth.getSession();
  const user = sessionData?.session?.user || loginData?.user;

  if (!user) {
    msg.textContent = "‚ö†Ô∏è Error obteniendo usuario autenticado.";
    msg.style.color = "orange";
    console.error("No se encontr√≥ usuario en la sesi√≥n.");
    return;
  }

  // üîπ Obtenim el perfil del participant
  const { data: perfil, error: perfilError } = await supabase
    .from("perfil_participantes")
    .select("nombre, correo")
    .eq("id", user.id)
    .single();

  if (perfilError || !perfil) {
    msg.textContent = "‚ö†Ô∏è No se ha encontrado el perfil del usuario.";
    msg.style.color = "orange";
    console.error(perfilError);
    return;
  }

  // üü¢ Guardem nom i correu al localStorage
  localStorage.setItem("participante", JSON.stringify({
    id: user.id,
    nombre: perfil.nombre,
    correo: perfil.correo
  }));

  msg.textContent = "‚úÖ Sesi√≥n iniciada correctamente.";
  msg.style.color = "green";

  // Esperem una mica abans de redirigir
  setTimeout(() => {
    window.location.href = "quiniela_participante.html";
  }, 1000);
});



</script>

</body>
</html>
