<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8">
  <title>Les meves Quinieles</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #f0f4f8;
      margin: 0;
      padding-top: 80px; /* espai per la barra superior fixa */
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* üîπ Barra superior */
    header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 100;
    }

    header h1 {
      font-size: 20px;
      color: #4f46e5;
      margin: 0;
    }

    /* üîπ Men√∫ superior de filtres */
    nav {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    nav button {
      background: #eef2ff;
      border: none;
      border-radius: 8px;
      padding: 8px 14px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s;
    }

    nav button:hover {
      background: #c7d2fe;
    }

    nav button.active {
      background: #4f46e5;
      color: white;
    }

    /* üîπ Bot√≥ ‚ÄúNova Quiniela‚Äù */
    #nueva {
      padding: 10px 18px;
      background: #4f46e5;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      transition: transform 0.2s, background 0.2s;
    }

    #nueva:hover { background: #3b82f6; transform: translateY(-2px); }

    /* üîπ Quinieles */
    #quinielasContainer {
      width: 100%;
      max-width: 600px;
      padding: 0 20px;
    }

    .quiniela-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      margin: 15px 0;
      padding: 20px;
    }

    .quiniela-card h3 {
      margin: 0 0 10px 0;
      color: #333;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      padding: 6px;
      border-bottom: 1px solid #eee;
      text-align: center;
    }

    th { background: #eef2ff; }

    #message { margin-top: 15px; font-size: 14px; text-align:center; }

    a {
      margin-top: 30px;
      color: #3b82f6;
      text-decoration: none;
      font-weight: 500;
    }

    /* üîπ Popup Bizum */
    .popup-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .popup-content {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      max-width: 400px;
      text-align: center;
      animation: fadeIn 0.3s ease-in-out;
    }

    .popup-content h3 {
      margin-top: 0;
      color: #4f46e5;
    }

    .popup-content button {
      margin-top: 20px;
      padding: 10px 20px;
      background: #4f46e5;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }

    .popup-content button:hover {
      background: #3b82f6;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
  </style>
</head>

<body>
  <!-- üîπ Barra superior -->
  <header>
    <h1>Les Meves Quinieles ‚öΩ</h1>
    <nav>
      <button id="btnTotes" class="active">Totes</button>
      <button id="btnActives">Actives</button>
      <button id="btnAntigues">Antigues</button>
      <button id="nueva">‚ûï Nova</button>
    </nav>
  </header>

  <div id="quinielasContainer">Carregant les teves quinieles...</div>
  <div id="message"></div>
  <a href="index.html">‚¨Ö Tornar al men√∫ principal</a>

  <!-- üîπ Popup Bizum -->
  <div id="popupBizum" class="popup-overlay" style="display:none;">
    <div class="popup-content">
      <h3>Informaci√≥ important üßæ</h3>
      <p>Per tal que la quiniela sigui v√†lida, cal fer un <strong>Bizum de 2‚Ç¨</strong> un cop completada al n√∫mero:</p>
      <p style="font-size: 18px; font-weight: bold; color: #2563eb;">üì± +34 611 456 094</p>
      <p>Gr√†cies per participar i molta sort! üçÄ</p>
      <button id="popupClose">Ent√®s!</button>
    </div>
  </div>

  <script type="module">
    import { supabase } from './supabaseClient.js';

    const container = document.getElementById('quinielasContainer');
    const btnNueva = document.getElementById('nueva');
    const msg = document.getElementById('message');
    const btnTotes = document.getElementById('btnTotes');
    const btnActives = document.getElementById('btnActives');
    const btnAntigues = document.getElementById('btnAntigues');

    let participant = null;
    let quinieles = [];
    let quinielaActivaId = null;
    let filtre = 'totes';

    async function checkLogin() {
      const { data: { session } } = await supabase.auth.getSession();
      participant = JSON.parse(localStorage.getItem('participante') || '{}');
      if (!session || !participant?.id) {
        alert('‚ö†Ô∏è Has d‚Äôiniciar sessi√≥ abans de veure les teves quinieles.');
        window.location.href = 'participante.html';
        return false;
      }
      return true;
    }

    async function getQuinielaActiva() {
      const { data } = await supabase.from('quiniela_oficial').select('*').eq('activa', true).single();
      quinielaActivaId = data?.id || null;
    }

    async function cargarMisQuinielas() {
      container.innerHTML = 'Carregant...';
      const { data, error } = await supabase
        .from('quinielas_participantes')
        .select('id, resultados, fecha, pagado, quiniela_id')
        .eq('participante_id', participant.id)
        .order('fecha', { ascending: false });

      if (error) {
        container.innerHTML = `<p style="color:red;">‚ùå Error: ${error.message}</p>`;
        return;
      }

      quinieles = data;
      renderFiltrades();
    }

    async function renderFiltrades() {
      container.innerHTML = '';
      const filtrades = quinieles.filter(q => {
        if (filtre === 'actives') return q.quiniela_id === quinielaActivaId;
        if (filtre === 'antigues') return q.quiniela_id !== quinielaActivaId;
        return true;
      });

      if (filtrades.length === 0) {
        container.innerHTML = '<p>No hi ha quinieles en aquesta categoria.</p>';
        return;
      }

      for (const q of filtrades) {
        const { data: quinielaData } = await supabase
          .from('quiniela_oficial')
          .select('data')
          .eq('id', q.quiniela_id)
          .single();
        const partits = quinielaData?.data || [];
        const esActiva = q.quiniela_id === quinielaActivaId;
        const card = document.createElement('div');
        card.className = 'quiniela-card';
        card.innerHTML = `
          <h3>${esActiva ? '‚öΩ Quiniela Activa' : 'üìú Quiniela anterior'}</h3>
          <p><strong>Data:</strong> ${new Date(q.fecha).toLocaleString()}</p>
          <p><strong>Pagat:</strong> ${q.pagado ? '‚úÖ S√≠' : '‚ùå No'}</p>
          ${renderPartidos(q.resultados, partits)}
        `;
        container.appendChild(card);
      }
    }

    function renderPartidos(resultados, partidos) {
      if (!Array.isArray(resultados)) {
        resultados = Object.keys(resultados)
          .sort((a, b) => Number(a) - Number(b))
          .map(k => resultados[k]);
      }
      let html = '<table><tr><th>Partit</th><th>Selecci√≥</th></tr>';
      partidos.forEach((p, i) => {
        html += `<tr><td>${p.local} vs ${p.visitante}</td><td>${resultados[i] || '-'}</td></tr>`;
      });
      return html + '</table>';
    }

    // üîπ Botons de filtre
    [btnTotes, btnActives, btnAntigues].forEach(b => {
      b.addEventListener('click', () => {
        [btnTotes, btnActives, btnAntigues].forEach(x => x.classList.remove('active'));
        b.classList.add('active');
        filtre = b.id.replace('btn', '').toLowerCase();
        renderFiltrades();
      });
    });

    // üîπ Nova quiniela
    btnNueva.addEventListener('click', () => {
      if (!quinielaActivaId) {
        alert('‚ö†Ô∏è No hi ha cap quiniela activa.');
        return;
      }
      document.getElementById('popupBizum').style.display = 'flex';
      document.getElementById('popupClose').onclick = () => {
        document.getElementById('popupBizum').style.display = 'none';
        window.location.href = `quiniela_participante.html?quiniela_id=${quinielaActivaId}`;
      };
    });

    if (await checkLogin()) {
      await getQuinielaActiva();
      await cargarMisQuinielas();
    }
  </script>
</body>
</html>
