<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Les meves Quinieles</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #f0f4f8;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 { color: #333; margin-bottom: 5px; }
    h2 { color: #2563eb; margin-top: 10px; }
    .quiniela-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 500px;
      margin: 10px 0;
      padding: 20px;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 6px; border-bottom: 1px solid #eee; text-align: center; }
    th { background: #eef2ff; }
    #nueva {
      margin-top: 20px;
      padding: 12px 20px;
      background: #4f46e5;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: transform 0.2s;
    }
    #nueva:hover { transform: translateY(-2px); background: #3b82f6; }
    #message { margin-top: 10px; font-size: 14px; text-align:center; }
    a { margin-top: 20px; color: #3b82f6; text-decoration: none; font-weight: 500; }
  </style>
</head>
<body>

  <h1>Benvingut/da a la teva zona de participant üëã</h1>
  <h2 id="nombreUsuario"></h2>

  <div id="quinielasContainer">Carregant les teves quinieles...</div>

  <button id="nueva">‚ûï Nova Quiniela</button>

  <div id="message"></div>
  <a href="index.html">‚¨Ö Tornar al men√∫ principal</a>

  <script type="module">
    import { supabase } from './supabaseClient.js';

    const container = document.getElementById('quinielasContainer');
    const btnNueva = document.getElementById('nueva');
    const msg = document.getElementById('message');
    const nombreUsuario = document.getElementById('nombreUsuario');

    let participante = null;
    let quinielaActiva = null;
    let quinielaActivaId = null;

    // ‚úÖ Comprovar sessi√≥
    async function checkLogin() {
      const { data: { session } } = await supabase.auth.getSession();
      participante = JSON.parse(localStorage.getItem('participante') || '{}');

      if (!session || !participante?.id) {
        alert('‚ö†Ô∏è Has d‚Äôiniciar sessi√≥ abans de veure les teves quinieles.');
        window.location.href = 'participante.html';
        return false;
      }

      nombreUsuario.textContent = `${participante.nombre}`;
      return true;
    }

    // üü¶ Obtenir quiniela activa (amb partits)
    async function getQuinielaActiva() {
      const { data, error } = await supabase
        .from('quiniela_oficial')
        .select('*')
        .eq('activa', true)
        .single();

      if (error || !data) {
        msg.textContent = '‚ùå No hi ha cap quiniela activa actualment.';
        msg.style.color = 'red';
        btnNueva.disabled = true;
        return null;
      }

      quinielaActiva = data;
      quinielaActivaId = data.id;
      console.log('üü¢ Quiniela activa carregada:', quinielaActiva);
      return data;
    }

    // üèÜ Mostrar partits amb equips
    function renderPartidos(resultados, partidos) {
      if (!resultados) return '<p>Sense resultats</p>';

      // Si els partits venen a la columna "data", no "partidos"
      const llista = partidos || quinielaActiva?.data;

      if (!llista) {
        return `<pre>${JSON.stringify(resultados, null, 2)}</pre>`;
      }

      let html = '<table>';
      html += '<tr><th>Partit</th><th>Selecci√≥</th></tr>';

      llista.forEach((p, i) => {
        const seleccio = resultados[i] || '-';
        html += `
          <tr>
            <td>${p.local || p.equip1} vs ${p.visitante || p.equip2}</td>
            <td>${seleccio}</td>
          </tr>`;
      });

      html += '</table>';
      return html;
    }

    // üìã Carregar quinieles del participant
    async function cargarMisQuinielas() {
      container.innerHTML = 'Carregant les teves quinieles...';

      const { data, error } = await supabase
        .from('quinielas_participantes')
        .select('id, resultados, fecha, pagado, quiniela_id')
        .eq('participante_id', participante.id)
        .order('fecha', { ascending: false });

      if (error) {
        container.innerHTML = `<p style="color:red;">‚ùå Error carregant les teves quinieles: ${error.message}</p>`;
        return;
      }

      if (!data || data.length === 0) {
        container.innerHTML = '<p>Encara no has fet cap quiniela.</p>';
        return;
      }

      container.innerHTML = '';
      data.forEach(q => {
        const esActiva = q.quiniela_id === quinielaActivaId;
        const card = document.createElement('div');
        card.className = 'quiniela-card';
        card.innerHTML = `
          <h3>${esActiva ? '‚öΩ Quiniela Activa' : 'üìú Quiniela anterior'}</h3>
          <p><strong>Data:</strong> ${new Date(q.fecha).toLocaleString()}</p>
          <p><strong>Pagat:</strong> ${q.pagado ? '‚úÖ S√≠' : '‚ùå No'}</p>
          ${renderPartidos(q.resultados, quinielaActiva?.data)}
        `;
        container.appendChild(card);
      });
    }

    // ‚ûï Bot√≥ nova quiniela (ara funcional amb id activa)
    btnNueva.addEventListener('click', () => {
      if (!quinielaActivaId) {
        alert('‚ö†Ô∏è No hi ha cap quiniela activa.');
        return;
      }
      window.location.href = `quiniela_participante.html?quiniela_id=${quinielaActivaId}`;
    });

    // üîÑ Execuci√≥ inicial
    if (await checkLogin()) {
      await getQuinielaActiva();
      await cargarMisQuinielas();
    }
  </script>
</body>
</html>
