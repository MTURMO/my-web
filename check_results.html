<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Resultados y Ranking</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  font-family: 'Inter', sans-serif;
  background: #f3f4f6;
  padding: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
}
h1 {
  color: #333;
  margin-bottom: 20px;
  text-align: center;
}
button {
  padding: 10px 18px;
  border: none;
  border-radius: 8px;
  background: linear-gradient(90deg, #6366f1, #3b82f6);
  color: white;
  font-weight: 600;
  cursor: pointer;
  margin: 8px;
  transition: transform 0.2s;
}
button:hover {
  transform: translateY(-2px);
}
#partidosContainer, #ranking {
  background: white;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  max-width: 600px;
  width: 100%;
  margin-top: 20px;
}
.match {
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid #ddd;
  padding: 10px 0;
}
.match span {
  flex: 1;
}
select {
  padding: 6px;
  border-radius: 6px;
  border: 1px solid #ccc;
}
#ranking table {
  width: 100%;
  border-collapse: collapse;
}
#ranking th, #ranking td {
  border-bottom: 1px solid #eee;
  padding: 8px;
  text-align: center;
}
#ranking th {
  background: #eef2ff;
}
.hidden { display: none; }
</style>
</head>
<body>
<h1>Gesti√≥n de Resultados</h1>

<div>
  <button id="btnAfegir">üìù Afegir Resultats</button>
  <button id="btnRanking">üèÜ Calcular Ranking</button>
</div>

<div id="partidosContainer" class="hidden"></div>
<div id="ranking" class="hidden"></div>

<a href="admin.html" style="margin-top:25px;color:#3b82f6;text-decoration:none;">‚¨Ö Tornar al men√∫ admin</a>

<script type="module">
import { supabase } from './supabaseClient.js';

(async () => {
  // üîê Comprovaci√≥ sessi√≥ i admin
  const { data: { session } } = await supabase.auth.getSession();
  const isLocalAdmin = localStorage.getItem("isAdmin") === "true";
  const isSupabaseAdmin = session?.user?.email === "admin@quiniela.com";

  if (!isLocalAdmin && !isSupabaseAdmin) {
    alert("Acceso restringido. Debes iniciar sesi√≥n como administrador.");
    window.location.href = "admin.html";
    return;
  }

  const btnAfegir = document.getElementById("btnAfegir");
  const btnRanking = document.getElementById("btnRanking");
  const cont = document.getElementById("partidosContainer");
  const rankingDiv = document.getElementById("ranking");

  let quinielaActiva = null;

  // üü¢ Carrega la quiniela activa
  async function cargarQuinielaActiva() {
    const { data, error } = await supabase
      .from("quiniela_oficial")
      .select("*")
      .eq("activa", true)
      .single();

    if (error || !data) {
      alert("‚ùå No s'ha trobat cap quiniela activa.");
      return null;
    }

    quinielaActiva = data;
    return data;
  }

  // üìù Afegir resultats
  btnAfegir.addEventListener("click", async () => {
    rankingDiv.classList.add("hidden");

    const quiniela = await cargarQuinielaActiva();
    if (!quiniela) return;

    cont.classList.remove("hidden");
    cont.innerHTML = "<h2 style='text-align:center;margin-bottom:10px;'>Introdueix els resultats</h2>";

    quiniela.data.forEach((p, i) => {
      const val = quiniela.resultados_validos?.[i] || "";
      cont.innerHTML += `
        <div class="match">
          <span>${p.local} vs ${p.visitante}</span>
          <select id="res-${i}">
            <option value="">‚Äî</option>
            <option value="1" ${val==="1"?"selected":""}>1</option>
            <option value="X" ${val==="X"?"selected":""}>X</option>
            <option value="2" ${val==="2"?"selected":""}>2</option>
          </select>
        </div>`;
    });

    cont.innerHTML += `<button id="guardarResultados" style="margin-top:15px;width:100%;">üíæ Guardar Resultats</button>`;

    document.getElementById("guardarResultados").addEventListener("click", guardarResultados);
  });

  // üíæ Guardar resultats v√†lids
  async function guardarResultados() {
    const resultados_validos = [];
    quinielaActiva.data.forEach((_, i) => {
      const val = document.getElementById(`res-${i}`).value;
      resultados_validos.push(val || null);
    });

    const { error: insertError } = await supabase
      .from("resultados_quiniela")
      .insert([{ quiniela_id: quinielaActiva.id, resultados_validos }]);

    if (insertError) {
      alert("‚ùå Error guardant resultats: " + insertError.message);
      return;
    }

    const { error } = await supabase
      .from("quiniela_oficial")
      .update({ resultados_validos })
      .eq("id", quinielaActiva.id);

    if (error) alert("‚ùå Error guardant resultats a quiniela_oficial: " + error.message);
    else alert("‚úÖ Resultats guardats correctament!");
  }

  // üèÜ Calcular ranking
  btnRanking.addEventListener("click", async () => {
    cont.classList.add("hidden");
    rankingDiv.classList.remove("hidden");
    rankingDiv.innerHTML = "<p>Calculant r√†nquing...</p>";

    const quiniela = await cargarQuinielaActiva();
    if (!quiniela || !quiniela.resultados_validos) {
      rankingDiv.innerHTML = "<p style='color:red;'>‚ùå No hi ha resultats v√†lids definits.</p>";
      return;
    }

    const { data: participants, error } = await supabase
      .from("quinielas_participantes")
      .select("*")
      .eq("pagado", true)
      .eq("quiniela_id", quinielaActiva.id);

    if (error) {
      rankingDiv.innerHTML = "<p style='color:red;'>Error carregant participants.</p>";
      return;
    }

    if (!participants || participants.length === 0) {
      rankingDiv.innerHTML = "<p>No hi ha participants pagats per aquesta quiniela.</p>";
      return;
    }

    const rankingTemp = participants.map(p => {
        let encerts = 0;
        quiniela.resultados_validos.forEach((res, i) => {
            if (res && p.resultados?.[i] === res) encerts++;
        });
        return {
            nom: p.nombre || "‚Äî",
            correu: p.correo || "‚Äî",
            encerts
        };
    });



    const rankingMap = new Map();
    rankingTemp.forEach(r => {
      if (!rankingMap.has(r.correu)) rankingMap.set(r.correu, { ...r });
      else rankingMap.get(r.correu).encerts += r.encerts;
    });

    const ranking = Array.from(rankingMap.values()).sort((a,b) => b.encerts - a.encerts);

    let html = "<h2 style='text-align:center;margin-bottom:10px;'>üèÜ R√†nquing Quiniela Activa</h2>";
    html += "<table><tr><th>#</th><th>Nom</th><th>Correu</th><th>Encerts</th></tr>";
    ranking.forEach((r,i) => html += `<tr><td>${i+1}</td><td>${r.nom}</td><td>${r.correu}</td><td>${r.encerts}</td></tr>`);
    html += "</table>";
    html += `<button id="guardarRanking" style="margin-top:15px;width:100%;">üíæ Guardar Ranking General</button>`;
    rankingDiv.innerHTML = html;

    document.getElementById("guardarRanking").addEventListener("click", async () => {
      for (const r of ranking) {
        if (!r.correu) continue;

        const { data: existent } = await supabase
          .from("resultados_generales")
          .select("puntos_totales")
          .eq("correo", r.correu)
          .single();

        const puntsTotals = (existent?.puntos_totales || 0) + r.encerts;

        await supabase.from("resultados_generales").upsert({
          correo: r.correu,
          nombre: r.nom,
          puntos_totales: puntsTotals,
          ultima_actualizacion: new Date().toISOString()
        }, { onConflict: "correo" });

        await supabase.from("resultados_detalle").insert({
          correo: r.correu,
          nombre: r.nom,
          quiniela_nombre: quinielaActiva.nombre || "Quiniela sense nom",
          puntos: r.encerts
        });
      }

      alert("‚úÖ Ranking guardat correctament al total i al detall per jornada!");
    });
  });
})();
</script>


</body>
</html>
