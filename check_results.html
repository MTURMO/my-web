<script type="module">
import { supabase } from './supabaseClient.js';

const btnAfegir = document.getElementById("btnAfegir");
const btnRanking = document.getElementById("btnRanking");
const cont = document.getElementById("partidosContainer");
const rankingDiv = document.getElementById("ranking");

let quinielaActiva = null;
let rankingActual = [];

// ğŸŸ¢ Cargar quiniela activa
async function cargarQuinielaActiva() {
  const { data, error } = await supabase
    .from("quiniela_oficial")
    .select("*")
    .eq("activa", true)
    .single();

  if (error || !data) {
    alert("âŒ No s'ha trobat cap quiniela activa.");
    return null;
  }

  quinielaActiva = data;
  return data;
}

// ğŸ“ AÃ±adir resultados correctos
btnAfegir.addEventListener("click", async () => {
  rankingDiv.classList.add("hidden");

  const quiniela = await cargarQuinielaActiva();
  if (!quiniela) return;

  cont.classList.remove("hidden");
  cont.innerHTML = "<h2 style='text-align:center;margin-bottom:10px;'>Resultats Oficials</h2>";

  quiniela.data.forEach((p, i) => {
    const val = quiniela.resultados_validos?.[i] || "";
    cont.innerHTML += `
      <div class="match">
        <span>${p.local} vs ${p.visitante}</span>
        <select id="res-${i}">
          <option value="">â€”</option>
          <option value="1" ${val==="1"?"selected":""}>1</option>
          <option value="X" ${val==="X"?"selected":""}>X</option>
          <option value="2" ${val==="2"?"selected":""}>2</option>
        </select>
      </div>`;
  });

  cont.innerHTML += `<button id="guardarResultados" style="margin-top:15px;width:100%;">ğŸ’¾ Guardar Resultats Oficials</button>`;
  document.getElementById("guardarResultados").addEventListener("click", guardarResultados);
});

// ğŸ’¾ Guardar quiniela correcta
async function guardarResultados() {
  const resultados_validos = [];

  quinielaActiva.data.forEach((_, i) => {
    const val = document.getElementById(`res-${i}`).value;
    resultados_validos.push(val || null);
  });

  // 1ï¸âƒ£ Guardar dentro de tabla auxiliar 'resultados_quiniela'
  const { error: insertError } = await supabase
    .from("resultados_quiniela")
    .insert([
      {
        quiniela_id: quinielaActiva.id,
        resultados_validos,
        creada_el: new Date().toISOString()
      }
    ]);

  if (insertError) {
    alert("âŒ Error guardant resultats oficials: " + insertError.message);
    return;
  }

  // 2ï¸âƒ£ Actualizar tambiÃ©n dentro de la quiniela_oficial activa (opcional)
  await supabase
    .from("quiniela_oficial")
    .update({ resultados_validos })
    .eq("id", quinielaActiva.id);

  alert("âœ… Resultats oficials guardats correctament!");
}

// ğŸ† Calcular ranking (solo pagados)
btnRanking.addEventListener("click", async () => {
  cont.classList.add("hidden");
  rankingDiv.classList.remove("hidden");
  rankingDiv.innerHTML = "<p>Calculant rÃ nquing...</p>";

  const quiniela = await cargarQuinielaActiva();
  if (!quiniela?.resultados_validos) {
    rankingDiv.innerHTML = "<p style='color:red;'>âŒ No hi ha resultats vÃ lids.</p>";
    return;
  }

  const { data: participants, error } = await supabase
    .from("quinielas_participantes")
    .select("*")
    .eq("pagado", true) // SOLO los que han pagado
    .order("fecha", { ascending: false });

  if (error) {
    rankingDiv.innerHTML = "<p style='color:red;'>Error carregant participants.</p>";
    return;
  }

  rankingActual = participants.map(p => {
    let encerts = 0;
    quiniela.resultados_validos.forEach((res, i) => {
      if (res && p.resultados?.[i] === res) encerts++;
    });
    return {
      nom: p.participante?.nombre || "â€”",
      correu: p.participante?.correo || "â€”",
      encerts
    };
  });

  rankingActual.sort((a, b) => b.encerts - a.encerts);

  let html = "<h2 style='text-align:center;margin-bottom:10px;'>ğŸ† RÃ nquing Quiniela Activa</h2>";
  html += "<table><tr><th>#</th><th>Nom</th><th>Correu</th><th>Encerts</th></tr>";

  rankingActual.forEach((r, i) => {
    html += `<tr><td>${i+1}</td><td>${r.nom}</td><td>${r.correu}</td><td>${r.encerts}</td></tr>`;
  });

  html += "</table>";
  html += `<button id="guardarRanking" style="margin-top:15px;width:100%;">ğŸ’¾ Guardar Resultats Generals</button>`;
  rankingDiv.innerHTML = html;

  document.getElementById("guardarRanking").addEventListener("click", guardarRankingGeneral);
});

// ğŸ’¾ Guardar puntos acumulados
async function guardarRankingGeneral() {
  for (const r of rankingActual) {
    if (!r.correu) continue;

    // ğŸŸ¢ Insertar o actualizar (sumar puntos)
    const { data: existent } = await supabase
      .from("resultados_generales")
      .select("puntos_totales")
      .eq("correo", r.correu)
      .single();

    const puntos_totales = (existent?.puntos_totales || 0) + r.encerts;

    const { error } = await supabase
      .from("resultados_generales")
      .upsert([
        {
          correo: r.correu,
          nombre: r.nom,
          puntos_totales,
          ultima_actualizacion: new Date().toISOString()
        }
      ], { onConflict: 'correo' });

    if (error) console.error("Error guardant punts per", r.correu, error);
  }

  alert("âœ… Resultats generals actualitzats correctament!");
}
</script>
