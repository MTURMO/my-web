<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Administrador</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  *{box-sizing:border-box;margin:0;padding:0;font-family:'Inter',sans-serif;}
  body{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;background:#eef2ff;}
  h1{font-size:2rem;margin-bottom:1rem;color:#333;}
  input, button{padding:12px 20px;font-size:16px;margin:10px;border-radius:10px;border:none;}
  input{width:250px;border:1px solid #ccc;}
  button{background:linear-gradient(90deg,#6366f1,#3b82f6);color:white;font-weight:600;cursor:pointer;transition:transform 0.2s;}
  button:hover{transform:translateY(-2px);}
  .hidden{display:none;}
  .menu button{width:220px;margin:15px 0;background:linear-gradient(90deg,#10b981,#14b8a6);}
  .menu button:hover{transform:translateY(-2px);}
  a{margin-top:20px;color:#3b82f6;text-decoration:none;font-weight:500;}
</style>
</head>
<body>

<!-- Login -->
<div id="login" class="hidden">
  <h1>Acceso Administrador</h1>
  <input type="password" id="password" placeholder="Contrase√±a"><br>
  <button id="loginBtn">Entrar</button>
  <p id="error" style="color:red;"></p>
  <a href="index.html" style="margin-top:15px;color:#3b82f6;display:inline-block;">‚¨Ö Volver al Men√∫ Principal</a>
</div>

<!-- Men√∫ Admin -->
<div id="menu" class="hidden">
  <h1>Men√∫ Administrador</h1>
  <div class="menu">
    <button onclick="window.location.href='upload.html'">New Form</button>
    <button onclick="window.location.href='check_payments.html'">Check Payments</button>
    <button onclick="window.location.href='check_results.html'">Check Results</button>
    <button id="cerrarParticipacionBtn" style="background:linear-gradient(90deg,#ef4444,#f87171);">Cerrar Participaci√≥n</button>
  </div>
  <button id="logoutBtn" style="background:linear-gradient(90deg,#6366f1,#3b82f6);">Cerrar Sesi√≥n</button>
  <a href="index.html">‚¨Ö Volver al Men√∫ Principal</a>
</div>

<script type="module">
// ------------------------------
// üîê Autenticaci√≥n con Supabase
// ------------------------------
import { supabase } from './supabaseClient.js';

const loginDiv = document.getElementById("login");
const menuDiv = document.getElementById("menu");
const errorMsg = document.getElementById("error");
const passwordInput = document.getElementById("password");

// Comprovar sessi√≥ actual
const { data: { session } } = await supabase.auth.getSession();

if (session) {
  // Si ja est√† autenticat ‚Üí mostra men√∫ directament
  loginDiv.classList.add("hidden");
  menuDiv.classList.remove("hidden");
} else {
  // Si no ‚Üí mostra login
  loginDiv.classList.remove("hidden");
}

// üîë Login Supabase Auth
document.getElementById('loginBtn').addEventListener('click', async () => {
  const password = passwordInput.value.trim();
  if (!password) return (errorMsg.textContent = "Introdueix la contrasenya");

  const { data, error } = await supabase.auth.signInWithPassword({
    email: "admin@quiniela.com", // üß† usuari admin creat a Supabase
    password: password
  });

  if (error) {
    errorMsg.textContent = "‚ùå Contrase√±a incorrecta o error de autenticaci√≥n.";
    console.error(error);
    return;
  }

  loginDiv.classList.add("hidden");
  menuDiv.classList.remove("hidden");
  errorMsg.textContent = "";
});

// üö™ Logout
document.getElementById("logoutBtn").addEventListener("click", async () => {
  await supabase.auth.signOut();
  alert("Sesi√≥n cerrada correctamente.");
  location.reload();
});

// ------------------------------
// ‚öôÔ∏è Bot√≥n: Cerrar participaci√≥n
// ------------------------------
document.getElementById("cerrarParticipacionBtn").addEventListener("click", async () => {
  if (!confirm("¬øEst√°s seguro de cerrar la participaci√≥n? Esto bloquear√° la quiniela activa.")) return;

  try {
    const { error } = await supabase
      .from('quiniela_oficial')
      .update({ blocked: true })
      .eq('activa', true);

    if (error) throw error;
    alert("‚úÖ Participaci√≥n cerrada correctamente.");
  } catch (err) {
    console.error(err);
    alert("‚ùå Error al cerrar la participaci√≥n: " + (err.message || err));
  }
});
</script>

</body>
</html>
