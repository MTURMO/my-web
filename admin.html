<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Administrador</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  *{box-sizing:border-box;margin:0;padding:0;font-family:'Inter',sans-serif;}
  body{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;background:#eef2ff;}
  h1{font-size:2rem;margin-bottom:1rem;color:#333;}
  input, button{padding:12px 20px;font-size:16px;margin:10px;border-radius:10px;border:none;}
  input{width:250px;border:1px solid #ccc;}
  button{background:linear-gradient(90deg,#6366f1,#3b82f6);color:white;font-weight:600;cursor:pointer;transition:transform 0.2s;}
  button:hover{transform:translateY(-2px);}
  .hidden{display:none;}
  .menu button{width:220px;margin:15px 0;background:linear-gradient(90deg,#10b981,#14b8a6);}
  .menu button:hover{transform:translateY(-2px);}
  a{margin-top:20px;color:#3b82f6;text-decoration:none;font-weight:500;}
</style>
</head>
<body>

<!-- Login -->
<div id="login">
  <h1>Acceso Administrador</h1>
  <input type="password" id="password" placeholder="Contraseña"><br>
  <button id="loginBtn">Entrar</button>
  <p id="error" style="color:red;"></p>
  <a href="index.html" style="margin-top:15px;color:#3b82f6;display:inline-block;">⬅ Volver al Menú Principal</a>
</div>

<!-- Menú Admin -->
<div id="menu" class="hidden">
  <h1>Menú Administrador</h1>
  <div class="menu">
    <button onclick="window.location.href='upload.html'">New Form</button>
    <button onclick="window.location.href='check_payments.html'">Check Payments</button>
    <button onclick="window.location.href='check_results.html'">Check Results</button>
    <button id="cerrarParticipacionBtn" style="background:linear-gradient(90deg,#ef4444,#f87171);">Cerrar Participación</button>
  </div>
  <a href="index.html">⬅ Volver al Menú Principal</a>
</div>

<!-- Script (no-module) per al login: sempre s'executa encara que fallen imports modules -->
<script>
document.getElementById('loginBtn').addEventListener('click', () => {
  const input = document.getElementById("password").value;
  const error = document.getElementById("error");
  const correctPassword = "1234"; // canvia si cal
  if (input === correctPassword) {
    document.getElementById("login").classList.add("hidden");
    document.getElementById("menu").classList.remove("hidden");
    error.textContent = "";
  } else {
    error.textContent = "Contraseña incorrecta. Intenta de nuevo.";
  }
});
</script>

<!-- Mòdul per a Supabase: import dinàmic i manejo d'errors -->
<script type="module">
(async () => {
  const btnCerrar = document.getElementById("cerrarParticipacionBtn");
  if (!btnCerrar) return;

  try {
    // Import dinàmic — evita que fallades trenquin la resta de la pàgina
    const mod = await import('./supabaseClient.js');
    const supabase = mod.supabase || mod.default?.supabase || null;

    if (!supabase) {
      console.warn('supabase no exportat correctament des de supabaseClient.js. Revisa l\'export.');
      btnCerrar.addEventListener('click', () => {
        alert('Error: Supabase no disponible (manca export supabase). Mira la consola.');
      });
      return;
    }

    // Afegeix listener segur
    btnCerrar.addEventListener("click", async () => {
      if (!confirm("¿Estás seguro de cerrar la participación? Esto bloqueará la quiniela activa.")) return;

      try {
        const { data, error } = await supabase
          .from('quiniela_oficial')
          .update({ blocked: true })
          .eq('activa', true);

        if (error) throw error;
        alert("✅ Participación cerrada correctamente.");
      } catch (err) {
        console.error('Error actualizando quiniela:', err);
        alert("❌ Error al cerrar la participación: " + (err.message || err));
      }
    });

  } catch (err) {
    console.warn('No s\'ha pogut importar supabaseClient.js:', err);
    // fallback: el botó mostra un error informatiu
    btnCerrar.addEventListener('click', () => {
      alert('No s\'ha pogut conectar amb Supabase. Revisa la consola (Network / Import).');
    });
  }
})();
</script>

</body>
</html>
