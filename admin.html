<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Administrador</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  *{box-sizing:border-box;margin:0;padding:0;font-family:'Inter',sans-serif;}
  body{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;background:#eef2ff;}
  h1{font-size:2rem;margin-bottom:1rem;color:#333;}
  input, button{padding:12px 20px;font-size:16px;margin:10px;border-radius:10px;border:none;}
  input{width:250px;border:1px solid #ccc;}
  button{background:linear-gradient(90deg,#6366f1,#3b82f6);color:white;font-weight:600;cursor:pointer;transition:transform 0.2s;}
  button:hover{transform:translateY(-2px);}
  .hidden{display:none;}
  .menu button{width:220px;margin:15px 0;background:linear-gradient(90deg,#10b981,#14b8a6);}
  .menu button:hover{transform:translateY(-2px);}
  a{margin-top:20px;color:#3b82f6;text-decoration:none;font-weight:500;}
</style>
</head>
<body>

<!-- Login -->
<div id="login" class="hidden">
  <h1>Acceso Administrador</h1>
  <input type="password" id="password" placeholder="Contrase√±a"><br>
  <button id="loginBtn">Entrar</button>
  <p id="error" style="color:red;"></p>
  <a href="index.html" style="margin-top:15px;color:#3b82f6;display:inline-block;">‚¨Ö Volver al Men√∫ Principal</a>
</div>

<!-- Men√∫ Admin -->
<div id="menu" class="hidden">
  <h1>Men√∫ Administrador</h1>
  <div class="menu">
    <button onclick="window.location.href='upload.html'">New Form</button>
    <button onclick="window.location.href='check_payments.html'">Check Payments</button>
    <button onclick="window.location.href='check_results.html'">Check Results</button>
    <button id="cerrarParticipacionBtn" style="background:linear-gradient(90deg,#ef4444,#f87171);">Cerrar Participaci√≥n</button>
  </div>
  <button id="logoutBtn" style="background:linear-gradient(90deg,#6366f1,#3b82f6);">Cerrar Sesi√≥n</button>
  <a href="index.html">‚¨Ö Volver al Men√∫ Principal</a>
</div>

<script>
// ------------------------------
// üîê Control de sesi√≥n local
// ------------------------------
const correctPassword = "1234"; // puedes cambiarla o traerla de un entorno seguro

const isAdmin = localStorage.getItem("isAdmin");
const loginDiv = document.getElementById("login");
const menuDiv = document.getElementById("menu");

// Si ja est√† loguejat, mostra directament el men√∫
if (isAdmin === "true") {
  menuDiv.classList.remove("hidden");
} else {
  loginDiv.classList.remove("hidden");
}

// Login manual
document.getElementById('loginBtn').addEventListener('click', () => {
  const input = document.getElementById("password").value;
  const error = document.getElementById("error");

  if (input === correctPassword) {
    localStorage.setItem("isAdmin", "true"); // üß† Desa la sessi√≥
    loginDiv.classList.add("hidden");
    menuDiv.classList.remove("hidden");
    error.textContent = "";
  } else {
    error.textContent = "Contrase√±a incorrecta. Intenta de nuevo.";
  }
});

// Logout
document.getElementById("logoutBtn").addEventListener("click", () => {
  localStorage.removeItem("isAdmin");
  alert("Sesi√≥n cerrada correctamente.");
  window.location.reload();
});
</script>

<!-- M√≤dul Supabase -->
<script type="module">
(async () => {
  const btnCerrar = document.getElementById("cerrarParticipacionBtn");
  if (!btnCerrar) return;

  try {
    const mod = await import('./supabaseClient.js');
    const supabase = mod.supabase || mod.default?.supabase || null;

    if (!supabase) {
      console.warn('Supabase no exportat correctament.');
      btnCerrar.addEventListener('click', () => {
        alert('Error: Supabase no disponible.');
      });
      return;
    }

    // Bloquejar participaci√≥
    btnCerrar.addEventListener("click", async () => {
      if (!confirm("¬øEst√°s seguro de cerrar la participaci√≥n? Esto bloquear√° la quiniela activa.")) return;

      try {
        const { data, error } = await supabase
          .from('quiniela_oficial')
          .update({ blocked: true })
          .eq('activa', true);

        if (error) throw error;
        alert("‚úÖ Participaci√≥n cerrada correctamente.");
      } catch (err) {
        console.error('Error actualizando quiniela:', err);
        alert("‚ùå Error al cerrar la participaci√≥n: " + (err.message || err));
      }
    });

  } catch (err) {
    console.warn('No se pudo importar supabaseClient.js:', err);
    btnCerrar.addEventListener('click', () => {
      alert('No se pudo conectar con Supabase. Mira la consola.');
    });
  }
})();
</script>

</body>
</html>
