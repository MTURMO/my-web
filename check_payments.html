<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Gesti√≥n de Pagos</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family:'Inter',sans-serif; background:#f9fafb; padding:20px; display:flex; flex-direction:column; align-items:center; }
h1 { margin-bottom:20px; color:#333; text-align:center; }
table { border-collapse:collapse; width:100%; max-width:850px; background:white; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
th, td { border-bottom:1px solid #e5e7eb; padding:10px; text-align:center; word-wrap:break-word; }
th { background:#eef2ff; }
button { padding:6px 10px; border:none; border-radius:6px; cursor:pointer; background:linear-gradient(90deg,#10b981,#14b8a6); color:white; transition:transform 0.2s; }
button:hover { transform:translateY(-1px); }
#noData { margin-top:20px; color:#888; text-align:center; }
a { margin-top:20px; color:#3b82f6; text-decoration:none; font-weight:500; }

/* === Detalls Quiniela === */
.quiniela-detalle {
  background:#f3f4f6;
  border-radius:12px;
  margin:15px auto 20px auto;
  padding:0 15px;
  width:95%;
  max-width:750px;
  text-align:left;
  font-size:0.9rem;
  overflow:hidden;
  max-height:0;
  box-shadow:0 2px 8px rgba(0,0,0,0.1);
  transition:all 0.4s ease-in-out;
  opacity:0;
}
.quiniela-detalle.show {
  max-height:400px;
  padding:15px;
  opacity:1;
  overflow-y:auto;
}
.quiniela-detalle h3 { text-align:center; color:#333; margin-bottom:10px; }
.match { display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #ddd; padding:6px 0; }
.match span.equipos { font-weight:600; color:#111; }
.match span.pronostico { font-weight:500; padding:2px 6px; border-radius:6px; }
@media(max-width:600px){ th, td { font-size:13px; padding:6px; } table { font-size:14px; } .quiniela-detalle { font-size:0.8rem; } }
</style>
</head>
<body>

<h1>Gesti√≥n de Pagos</h1>

<table id="tablaPagos">
  <thead>
    <tr>
      <th>Nombre</th>
      <th>Correo</th>
      <th>Fecha</th>
      <th>Pagado</th>
      <th>Acci√≥n</th>
      <th>Ver Quiniela</th>
    </tr>
  </thead>
  <tbody id="tablaBody"></tbody>
</table>

<p id="noData">No hay quinielas enviadas todav√≠a.</p>

<a href="admin.html">‚¨Ö Volver al men√∫ admin</a>

<script type="module">
import { supabase } from './supabaseClient.js';

const tbody = document.getElementById("tablaBody");
const noData = document.getElementById("noData");

let partidosOficiales = [];
let quinielaActivaId = null;

// üîê Comprovar si l'usuari √©s admin
async function checkAdmin() {
  const { data: { session } } = await supabase.auth.getSession();

  if (!session) {
    alert("Debes iniciar sesi√≥n como administrador.");
    window.location.href = "admin.html";
    throw new Error("Acceso restringido");
  }

  // Comprovar email admin
  if (session.user.email !== "admin@quiniela.com") {
    alert("No tienes permisos de administrador.");
    window.location.href = "admin.html";
    throw new Error("Acceso restringido");
  }
}

// ‚öΩ Obtener la quiniela activa
async function obtenerQuinielaActiva() {
  const { data, error } = await supabase
    .from("quiniela_oficial")
    .select("*")
    .eq("activa", true)
    .single();

  if (error || !data) {
    console.error("Error cargando quiniela activa:", error);
    return null;
  }

  quinielaActivaId = data.id;
  partidosOficiales = data.data || [];
  return quinielaActivaId;
}

// üíæ Cargar quinielas de la quiniela activa
async function cargarPagos() {
  tbody.innerHTML = "";
  noData.style.display = "none";

  const idActiva = await obtenerQuinielaActiva();
  if (!idActiva) {
    noData.textContent = "No hi ha una quiniela activa.";
    noData.style.display = "block";
    return;
  }

  const { data: participantes, error } = await supabase
    .from("quinielas_participantes")
    .select("*")
    .eq("quiniela_id", idActiva)
    .order("fecha", { ascending: false });

  if (error) {
    console.error("Error cargando participantes:", error);
    noData.textContent = "Error al carregar participants.";
    noData.style.display = "block";
    return;
  }

  if (!participantes || participantes.length === 0) {
    noData.textContent = "No hi ha participacions a la quiniela activa.";
    noData.style.display = "block";
    return;
  }

  participantes.forEach((e, i) => {
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>${e.nombre || "‚Äî"}</td>
    <td>${e.correo || "‚Äî"}</td>
    <td>${new Date(e.fecha).toLocaleString()}</td>
    <td>${e.pagado ? "‚úÖ" : "‚ùå"}</td>
    <td><button onclick="togglePago(${e.id}, ${e.pagado})">${e.pagado ? "Desmarcar" : "Marcar pagado"}</button></td>
    <td><button id="btn-ver-${i}">üëÅ Veure Quiniela</button></td>
  `;
  tbody.appendChild(tr);
  
  const detalle = document.createElement("div");
  detalle.className = "quiniela-detalle";
  detalle.id = `detalle-${i}`;
  detalle.innerHTML = `<h3>Detalles de la Quiniela</h3>`;

  partidosOficiales.forEach((partido, j) => {
    const pronostico = e.resultados?.[j] || "‚Äî";
    detalle.innerHTML += `
      <div class="match">
        <span class="equipos">${partido.local} vs ${partido.visitante}</span>
        <span class="pronostico">${pronostico}</span>
      </div>`;
  });

  tbody.appendChild(detalle);

  const btn = document.getElementById(`btn-ver-${i}`);
  btn.addEventListener("click", () => {
    if (detalle.classList.contains("show")) {
      detalle.classList.remove("show");
      btn.textContent = "üëÅ Ver Quiniela";
    } else {
      detalle.classList.add("show");
      btn.textContent = "üëÅ Ocultar Quiniela";
    }
  });
});

}

// üü¢ Marcar o desmarcar pago i actualitzar recaptaci√≥
window.togglePago = async function(id, actual) {
  try {
    // 1Ô∏è‚É£ Obtenir la quiniela activa
    const { data: quinielaActiva, error: errorActiva } = await supabase
      .from("quiniela_oficial")
      .select("id")
      .eq("activa", true)
      .single();

    if (errorActiva || !quinielaActiva) {
      alert("‚ùå No s'ha trobat la quiniela activa.");
      return;
    }

    const quinielaId = quinielaActiva.id;

    // 2Ô∏è‚É£ Actualitzar estat de pagament del participant
    const { error: updateError } = await supabase
      .from("quinielas_participantes")
      .update({ pagado: !actual })
      .eq("id", id);

    if (updateError) {
      alert("‚ùå Error actualitzant pagament: " + updateError.message);
      return;
    }

    // 3Ô∏è‚É£ Buscar registre de recaptaci√≥ de la quiniela
    const { data: recData, error: recError } = await supabase
      .from("recaudacion_quinielas")
      .select("*")
      .eq("quiniela_id", quinielaId)
      .single();

    if (recError && recError.code !== "PGRST116") { // "no record found"
      console.error("Error consultant recaptaci√≥:", recError);
    }

    let recaudado = recData?.recaudado || 0;
    let acumulado = recData?.acumulado || 0;

    // 4Ô∏è‚É£ Sumar o restar 2‚Ç¨
    if (!actual) recaudado += 2; // si ara marquem com pagat
    else recaudado = Math.max(0, recaudado - 2); // si desmarquem

    acumulado = Math.max(acumulado, recaudado); // acumulat sempre >= recaudat

    // 5Ô∏è‚É£ Actualitzar o inserir registre
    if (recData) {
      await supabase
        .from("recaudacion_quinielas")
        .update({
          recaudado,
          acumulado,
          actualizado_en: new Date().toISOString(),
        })
        .eq("quiniela_id", quinielaId);
    } else {
      await supabase
        .from("recaudacion_quinielas")
        .insert([
          {
            quiniela_id: quinielaId,
            recaudado,
            acumulado,
            actualizado_en: new Date().toISOString(),
          },
        ]);
    }

    // 6Ô∏è‚É£ Tornem a carregar la taula
    cargarPagos();

  } catch (err) {
    console.error("Error a togglePago:", err);
    alert("‚ùå Error actualitzant pagament: " + err.message);
  }
};


// üîë Inicialitzar
document.addEventListener("DOMContentLoaded", async () => {
  await checkAdmin();
  cargarPagos();
});
</script>

</body>
</html>
