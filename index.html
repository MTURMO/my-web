<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="UTF-8">
<title>R√†nquing General</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  font-family: 'Inter', sans-serif;
  background: #f3f4f6;
  padding: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.info-btn, .login-btn {
  position: fixed;
  top: 20px;
  z-index: 1000;
  padding: 10px 20px;
  background: linear-gradient(90deg,#4f46e5,#3b82f6);
  color: white;
  border-radius: 10px;
  font-weight: 600;
  transition: transform 0.2s;
  border: none;
  cursor: pointer;
  font-family: 'Inter', sans-serif;
  font-size: 1rem;
}
.info-btn:hover, .login-btn:hover { transform: translateY(-2px); }
.info-btn { left: 20px; }
.login-btn { right: 20px; text-decoration: none; display: inline-block; }

h1 { font-size: 2rem; color: #333; margin-bottom: 10px; text-align:center; margin-top: 60px; }
h2 { color: #2563eb; margin-top: 40px; text-align: center; }

table {
  border-collapse: collapse;
  width: 100%;
  max-width: 700px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  margin-bottom: 20px;
  overflow: hidden;
}
th, td {
  padding: 12px;
  text-align: center;
  border-bottom: 1px solid #f3f4f6;
}
th {
  background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
  color: white;
  font-weight: 600;
  text-transform: uppercase;
  font-size: 0.85rem;
  letter-spacing: 0.5px;
  border-bottom: 3px solid #3b82f6;
}
tbody tr { transition: all 0.2s ease; }
tbody tr:hover { background: #f0f9ff; transform: scale(1.01); }
tbody tr:nth-child(odd) { background: #fafbff; }

/* Colors de p√≤dium */
#tablaRanking tbody tr:nth-child(1) {
  background: linear-gradient(90deg, #fef3c7 0%, #fde68a 100%);
  font-weight: 600;
}
#tablaRanking tbody tr:nth-child(1) td:first-child {
  color: #d97706; font-weight: 700; font-size: 1.2rem;
}
#tablaRanking tbody tr:nth-child(2) {
  background: linear-gradient(90deg, #f3f4f6 0%, #e5e7eb 100%);
  font-weight: 600;
}
#tablaRanking tbody tr:nth-child(2) td:first-child {
  color: #6b7280; font-weight: 700; font-size: 1.1rem;
}
#tablaRanking tbody tr:nth-child(3) {
  background: linear-gradient(90deg, #fed7aa 0%, #fdba74 100%);
  font-weight: 600;
}
#tablaRanking tbody tr:nth-child(3) td:first-child {
  color: #c2410c; font-weight: 700; font-size: 1.1rem;
}

/* Select bonic */
.select-xulo {
  padding: 10px 14px;
  border-radius: 10px;
  border: 2px solid #3b82f6;
  background: white;
  font-size: 1rem;
  font-weight: 500;
  color: #1e3a8a;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  cursor: pointer;
  transition: all 0.2s ease-in-out;
}
.select-xulo:hover {
  border-color: #4f46e5;
  box-shadow: 0 3px 8px rgba(0,0,0,0.1);
}
.select-xulo:focus {
  outline: none;
  border-color: #2563eb;
  box-shadow: 0 0 0 3px rgba(59,130,246,0.3);
}

/* Altres estils */
.menu {
  margin-top: 20px;
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  justify-content: center;
}
a.menu-link {
  padding: 10px 20px;
  background: linear-gradient(90deg,#4f46e5,#3b82f6);
  color: white;
  text-decoration: none;
  border-radius: 10px;
  font-weight: 600;
  transition: transform 0.2s;
}
a.menu-link:hover { transform: translateY(-2px); }

.tablas-lado { display: flex; flex-wrap: wrap; justify-content: center; gap: 30px; width: 100%; max-width: 1400px; }
.tabla { flex: 1 1 600px; }

.table-scroll { overflow-x: auto; width: 100%; }
.table-scroll table { min-width: 100%; }

</style>
</head>
<body>

<button id="btnInfo" class="info-btn">‚ÑπÔ∏è Informaci√≥</button>
<a href="participante.html" class="login-btn">üîê Login</a>

<h1>üèÜ R√†nquing General</h1>

<p>Consulta els punts totals o filtra per jornada:</p>
<select id="filtroQuiniela" class="select-xulo">
  <option value="">üîπ Totes les quinieles</option>
</select>

<table id="tablaRanking">
  <thead><tr><th>#</th><th>Nom</th><th>Punts</th></tr></thead>
  <tbody></tbody>
</table>

<div class="menu">
  <a href="admin.html" id="adminLink" class="menu-link">Administrador</a>
</div>

<script type="module">
import { supabase } from './supabaseClient.js';

const filtro = document.getElementById("filtroQuiniela");
const tbodyRanking = document.querySelector("#tablaRanking tbody");
const adminLink = document.getElementById("adminLink");

const { data: { session } } = await supabase.auth.getSession();
if (session?.user?.email !== "admin@quiniela.com") adminLink.style.display = "none";

// --- Carrega quinieles
async function cargarQuinielas() {
  const { data } = await supabase.from("quiniela_oficial")
    .select("id, nombre")
    .order("creada_el", { ascending: false });
  if (data) data.forEach(q => {
    const opt = document.createElement("option");
    opt.value = `${q.id}|${q.nombre}`;
    opt.textContent = q.nombre;
    filtro.appendChild(opt);
  });
}

// --- Carrega ranking
async function cargarRanking(seleccio = "") {
  tbodyRanking.innerHTML = `<tr><td colspan='3'>Carregant...</td></tr>`;
  let data = [];

  if (seleccio) {
    const [quinielaId, quinielaNom] = seleccio.split("|");
    let detalle;

    // Primer intentem per ID
    const { data: perId } = await supabase
      .from("resultados_detalle")
      .select("participante_id, nombre, puntos, quiniela_id")
      .eq("quiniela_id", quinielaId);

    detalle = perId;

    // Si no troba res per ID, provem pel nom
    if (!detalle?.length) {
      const { data: perNom } = await supabase
        .from("resultados_detalle")
        .select("participante_id, nombre, puntos, quiniela_nombre")
        .eq("quiniela_nombre", quinielaNom);
      detalle = perNom;
    }

    if (detalle?.length) {
      const agrupat = {};
      detalle.forEach(d => {
        if (!agrupat[d.participante_id])
          agrupat[d.participante_id] = { nom: d.nombre, punts: 0 };
        agrupat[d.participante_id].punts += d.puntos;
      });
      data = Object.values(agrupat).sort((a, b) => b.punts - a.punts);
    }
  } else {
    const { data: general } = await supabase
      .from("resultados_generales")
      .select("nombre, puntos_totales")
      .order("puntos_totales", { ascending: false });
    data = (general || []).map(d => ({ nom: d.nombre, punts: d.puntos_totales }));
  }

  if (!data.length)
    return (tbodyRanking.innerHTML = "<tr><td colspan='3'>No hi ha dades.</td></tr>");

  tbodyRanking.innerHTML = data
    .map((r, i) => `<tr><td>${i + 1}</td><td>${r.nom}</td><td>${r.punts}</td></tr>`)
    .join("");
}

filtro.addEventListener("change", e => cargarRanking(e.target.value));

await cargarQuinielas();
await cargarRanking();
</script>
</body>
</html>
